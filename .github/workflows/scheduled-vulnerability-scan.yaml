name: Scheduled Vulnerability Scan

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  issues: write
  security-events: write

jobs:
  scan-base-image:
    name: Scan SDK Base Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2

      - name: Run container vulnerability scan
        id: scan
        uses: "./.github/actions/trivy-container"
        with:
          chainguard-username: ${{ secrets.CHAINGUARD_USERNAME }}
          chainguard-password: ${{ secrets.CHAINGUARD_PASSWORD }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          fail-on-vulns: 'false'

      - name: Check for daprd vulnerabilities
        id: check-daprd
        run: |
          # Extract vulnerabilities specifically from daprd binary
          DAPRD_VULNS=$(cat trivy-container-results.json | jq -r '
            .Results[]
            | select(.Target | contains("daprd"))
            | .Vulnerabilities // []
            | length
          ' | awk '{s+=$1} END {print s+0}')

          echo "daprd_vulns=$DAPRD_VULNS" >> $GITHUB_OUTPUT

          if [ "$DAPRD_VULNS" -gt 0 ]; then
            echo "::warning::Found $DAPRD_VULNS vulnerabilities in daprd runtime!"
            echo "has_daprd_vulns=true" >> $GITHUB_OUTPUT
          else
            echo "daprd runtime is clean (0 vulnerabilities)"
            echo "has_daprd_vulns=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for CLI vulnerabilities
        id: check-cli
        run: |
          # Extract vulnerabilities from dapr CLI
          CLI_VULNS=$(cat trivy-container-results.json | jq -r '
            .Results[]
            | select(.Target | contains("usr/local/bin/dapr"))
            | .Vulnerabilities // []
            | length
          ' | awk '{s+=$1} END {print s+0}')

          echo "cli_vulns=$CLI_VULNS" >> $GITHUB_OUTPUT
          echo "Found $CLI_VULNS HIGH/CRITICAL vulnerabilities in dapr CLI"

      - name: Generate scan summary
        run: |
          echo "## Vulnerability Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | HIGH/CRITICAL Vulns | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| daprd (runtime) | ${{ steps.check-daprd.outputs.daprd_vulns }} | ${{ steps.check-daprd.outputs.daprd_vulns == '0' && 'âœ… Clean' || 'âš ï¸ Action Required' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| dapr CLI | ${{ steps.check-cli.outputs.cli_vulns }} | â„¹ï¸ Upstream issue |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** CLI vulnerabilities are in unused code paths (Helm packages)." >> $GITHUB_STEP_SUMMARY

      - name: Create issue if daprd has vulnerabilities
        if: steps.check-daprd.outputs.has_daprd_vulns == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const title = 'ðŸš¨ Security: Vulnerabilities detected in daprd runtime';
            const body = `## Vulnerability Alert

            The scheduled vulnerability scan has detected **HIGH/CRITICAL vulnerabilities** in the daprd runtime binary.

            ### Details
            - **Vulnerabilities found:** ${{ steps.check-daprd.outputs.daprd_vulns }}
            - **Scan date:** ${new Date().toISOString().split('T')[0]}

            ### Recommended Actions
            1. Check if Chainguard has a patched version: \`apk search dapr\`
            2. If available, update Dockerfile to use Chainguard APK
            3. If not, contact Chainguard via their support channel

            ### References
            - [Chainguard DAPR packages](https://images.chainguard.dev/directory/image/dapr-daprd/compare)
            - [DAPR releases](https://github.com/dapr/dapr/releases)

            /cc @atlanhq/builder-experience
            `;

            // Check if similar issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,daprd-vulnerability'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'daprd-vulnerability', 'priority:high']
              });
              console.log('Created new security issue');
            } else {
              console.log('Security issue already exists, skipping creation');
            }
