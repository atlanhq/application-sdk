# Application SDK Activities Documentation

This document provides comprehensive documentation for all activities in the Application SDK.

## Table of Contents
1. [Base Activities](#base-activities)
2. [Query Extraction Activities](#query-extraction-activities)
3. [Metadata Extraction Activities](#metadata-extraction-activities)
4. [Agent Activities](#agent-activities)
5. [Common Utilities](#common-utilities)

## Base Activities

### ActivitiesState
Base state model for workflow activities.

**Attributes:**
- `handler` (Optional[HandlerInterface]): Handler instance for activity-specific operations
- `workflow_args` (Optional[Dict[str, Any]]): Arguments passed to the workflow

### ActivitiesInterface
Abstract base class defining the interface for workflow activities.

**Methods:**
- `__init__()`: Initialize with empty state dictionary
- `_set_state(workflow_args: Dict[str, Any])`: Initialize or update state for current workflow
- `_get_state(workflow_args: Dict[str, Any])`: Retrieve state for current workflow
- `_clean_state()`: Remove state data for current workflow
- `preflight_check(workflow_args: Dict[str, Any])`: Perform preflight checks before workflow execution

## Query Extraction Activities

### SQLQueryExtractionActivities
Activities for extracting SQL queries from databases.

**Attributes:**
- `_state`: Internal state storage
- `sql_client_class`: Class for SQL client operations
- `handler_class`: Class for SQL handling operations
- `fetch_queries_sql`: SQL query template for fetching queries

**Methods:**
- `__init__(sql_client_class=None, handler_class=None)`: Initialize with optional custom classes
- `_set_state(workflow_args: Dict[str, Any])`: Set up state with SQL client and handler
- `fetch_queries(batch_input, raw_output: JsonOutput, **kwargs)`: Fetch and process queries
- `parallelize_query(query: str, timestamp_column: str, chunk_size: int, ...)`: Process query in chunks
- `get_query_batches(workflow_args: Dict[str, Any], **kwargs)`: Get batches of queries

### MinerArgs
Arguments for SQL query mining operations.

**Attributes:**
- `database_name_cleaned`: Cleaned name of target database
- `schema_name_cleaned`: Cleaned name of target schema
- `timestamp_column`: Name of timestamp column
- `chunk_size`: Number of records per chunk
- `current_marker`: Current timestamp marker
- `sql_replace_from`: Original SQL fragment to replace
- `sql_replace_to`: Replacement SQL fragment
- `ranged_sql_start_key`: Placeholder for range start timestamp
- `ranged_sql_end_key`: Placeholder for range end timestamp
- `miner_start_time_epoch`: Start time for mining (defaults to 14 days ago)

## Metadata Extraction Activities

### SQLMetadataExtractionActivities
Activities for extracting metadata from SQL databases.

**Attributes:**
- `fetch_database_sql`: SQL query for fetching databases
- `fetch_schema_sql`: SQL query for fetching schemas
- `fetch_table_sql`: SQL query for fetching tables
- `fetch_column_sql`: SQL query for fetching columns
- `sql_client_class`: Class for SQL client operations
- `handler_class`: Class for SQL handling operations
- `transformer_class`: Class for metadata transformation
- `tables_extraction_temp_table_regex_sql`: SQL for excluding temporary tables
- `column_extraction_temp_table_regex_sql`: SQL for excluding temporary columns

**Methods:**
- `__init__(sql_client_class=None, handler_class=None, transformer_class=None)`: Initialize with custom classes
- `_get_state(workflow_args: Dict[str, Any])`: Get current workflow state
- `_set_state(workflow_args: Dict[str, Any])`: Set up state with clients and handlers
- `_clean_state()`: Clean up resources after workflow
- `_process_rows(results: pd.DataFrame, typename: str, ...)`: Process DataFrame rows
- `_transform_batch(results, typename: str, ...)`: Transform batch of results
- `fetch_databases(batch_input, raw_output: JsonOutput, **kwargs)`: Fetch database metadata
- `fetch_schemas(batch_input, raw_output: JsonOutput, **kwargs)`: Fetch schema metadata
- `fetch_tables(batch_input, raw_output: JsonOutput, **kwargs)`: Fetch table metadata
- `fetch_columns(batch_input, raw_output: JsonOutput, **kwargs)`: Fetch column metadata
- `transform_data(raw_input, transformed_output: JsonOutput, **kwargs)`: Transform raw data

### SQLMetadataExtractionActivitiesState
State class for SQL metadata extraction activities.

**Attributes:**
- `sql_client`: Client for SQL database operations
- `handler`: Handler for SQL-specific operations
- `transformer`: Transformer for metadata conversion

## Agent Activities

### LangGraphActivities
Activities for LangGraph agent operations.

**Methods:**
- `run_agent(activity_input: Dict[str, Any])`: Run LangGraph agent with given task

**Global Functions:**
- `register_graph_builder(name: str, builder_func: Callable)`: Register graph builder function
- `get_graph_builder(name: str)`: Get graph builder by name

## Common Utilities

### Decorators
- `@auto_heartbeater`: Decorator for automatic heartbeat management
- `@transform`: Decorator for data transformation
- `@run_sync`: Decorator for running synchronous code

### Utils
- `get_workflow_id()`: Get current workflow ID
- Various helper functions for state management and data processing

## Usage Examples

### SQL Query Extraction
```python
activities = SQLQueryExtractionActivities()
result = await activities.fetch_queries(batch_input, raw_output)
```

### Metadata Extraction
```python
activities = SQLMetadataExtractionActivities()
await activities.fetch_databases(batch_input, raw_output)
```

### Agent Operations
```python
activities = LangGraphActivities()
result = await activities.run_agent({
    "user_query": "Process data",
    "graph_builder_name": "my_graph_builder"
})
```

## Error Handling

All activities include comprehensive error handling:
- Preflight checks before execution
- State validation
- Resource cleanup
- Detailed error logging
- Graceful failure handling

## Best Practices

1. Always use the provided decorators for activities
2. Implement proper state management
3. Clean up resources after workflow completion
4. Use appropriate error handling
5. Follow the activity interface patterns 