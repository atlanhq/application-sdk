# Workflows Documentation

This document provides a comprehensive overview of the Application SDK's workflows module, which implements Temporal workflows for various data processing tasks.

## Overview

The workflows module is organized into several components:
1. Base Workflow Interface: Common functionality for all workflows
2. LangGraph Workflow: Handles LangGraph agent operations
3. Metadata Extraction Workflows: Extract metadata from various sources
4. Query Extraction Workflows: Extract and process queries

## Base Workflow Interface (`__init__.py`)

```python
@workflow.defn
class WorkflowInterface(ABC):
    """Abstract base class for all workflow implementations.
    
    This class defines the interface that all workflows must implement and provides
    common functionality for workflow execution.
    
    Attributes:
        activities_cls (Type[ActivitiesInterface]): The activities class to be used
            by the workflow
        default_heartbeat_timeout (timedelta): Default heartbeat timeout (10s)
        default_start_to_close_timeout (timedelta): Default activity timeout (2h)
        
    Methods:
        get_activities: Get sequence of activities to execute
        run: Execute the workflow with given configuration
    """
    
    @staticmethod
    def get_activities(activities: ActivitiesInterface) -> Sequence[Callable[..., Any]]:
        """Get the sequence of activities for this workflow.
        
        Args:
            activities: The activities interface instance
            
        Returns:
            Sequence[Callable[..., Any]]: List of activity methods to execute
            
        Raises:
            NotImplementedError: If not implemented by subclass
        """
        
    @workflow.run
    async def run(self, workflow_config: Dict[str, Any]) -> None:
        """Run the workflow with the given configuration.
        
        Args:
            workflow_config: Includes workflow_id and other parameters
                workflow_id is used to extract configuration from state store
                
        Note:
            - Extracts workflow configuration from state store
            - Sets up workflow run ID and retry policy
            - Executes preflight check activity
        """
```

## LangGraph Workflow (`langgraph.py`)

```python
@workflow.defn
class LangGraphWorkflow(WorkflowInterface):
    """Temporal Workflow to execute LangGraph agent steps.
    
    This workflow handles the execution of LangGraph agent operations,
    including graph compilation and task execution.
    
    Attributes:
        activities_cls: The activities class for LangGraph operations
        state: Current state of the workflow
            - messages: List of messages
            - enriched_query: Processed query
            - steps_list: List of execution steps
            - validation_response: Validation results
            
    Methods:
        get_activities: Get sequence of LangGraph activities
        run: Execute the LangGraph workflow
    """
    
    def __init__(self):
        """Initialize workflow state."""
        self.state = {
            "messages": [],
            "enriched_query": "",
            "steps_list": [],
            "validation_response": "",
        }
        
    @staticmethod
    def get_activities(activities: ActivitiesInterface) -> Sequence[Callable[..., Any]]:
        """Get the sequence of activities for this workflow.
        
        Args:
            activities: The activities interface instance
            
        Returns:
            Sequence[Callable[..., Any]]: List of activity methods to execute
        """
        
    @workflow.run
    async def run(self, workflow_config: Dict[str, Any]) -> None:
        """Execute the LangGraph workflow.
        
        Args:
            workflow_config: Includes workflow_id and other parameters
            
        Note:
            - Initializes workflow state
            - Compiles the LangGraph
            - Executes the user's task
        """
```

## Metadata Extraction Workflows

### SQL Metadata Extraction (`metadata_extraction/sql.py`)

```python
@workflow.defn
class SQLMetadataExtractionWorkflow(MetadataExtractionWorkflow):
    """Workflow for extracting metadata from SQL databases.
    
    This workflow orchestrates the extraction of metadata from SQL databases,
    including databases, schemas, tables, and columns.
    
    Attributes:
        activities_cls: The activities class for metadata extraction
        application_name: Name of the application ("sql-connector")
        
    Methods:
        get_activities: Get sequence of metadata extraction activities
        fetch_and_transform: Fetch and transform metadata in batches
        get_transform_batches: Get batches for parallel processing
        run: Execute the metadata extraction workflow
    """
    
    @staticmethod
    def get_activities(activities: SQLMetadataExtractionActivities) -> Sequence[Callable[..., Any]]:
        """Get the sequence of activities to be executed.
        
        Returns:
            Sequence[Callable[..., Any]]: Activities for:
                - Preflight check
                - Fetching databases
                - Fetching schemas
                - Fetching tables
                - Fetching columns
                - Transforming data
        """
        
    async def fetch_and_transform(
        self,
        fetch_fn: Callable[[Dict[str, Any]], Coroutine[Any, Any, Dict[str, Any]]],
        workflow_args: Dict[str, Any],
        retry_policy: RetryPolicy,
    ) -> None:
        """Fetch and transform metadata using the provided fetch function.
        
        Args:
            fetch_fn: Function to fetch metadata
            workflow_args: Arguments for workflow execution
            retry_policy: Retry policy for activity execution
            
        Note:
            - Handles chunking of data
            - Supports parallel processing
            - Validates activity statistics
        """
        
    def get_transform_batches(self, chunk_count: int, typename: str):
        """Get batches for parallel transformation processing.
        
        Args:
            chunk_count: Total number of chunks to process
            typename: Type name for the chunks
            
        Returns:
            Tuple[List[List[str]], List[int]]:
                - List of batches (file paths)
                - List of starting chunk numbers
        """
```

## Query Extraction Workflows

### SQL Query Extraction (`query_extraction/sql.py`)

```python
@workflow.defn
class SQLQueryExtractionWorkflow(QueryExtractionWorkflow):
    """SQL query extraction workflow implementation.
    
    This class implements the workflow for extracting SQL queries from databases.
    It handles batch processing of queries and manages the workflow state.
    
    Attributes:
        activities_cls: The activities class for SQL query extraction
        fetch_queries_sql: SQL query for fetching queries
        sql_client: SQL client instance
        application_name: Name of the application
        batch_size: Size of each batch for processing (default: 100000)
        
    Methods:
        get_activities: Get sequence of query extraction activities
        run: Execute the query extraction workflow
    """
    
    @staticmethod
    def get_activities(activities: ActivitiesInterface) -> Sequence[Callable[..., Any]]:
        """Get the sequence of activities for this workflow.
        
        Returns:
            Sequence[Callable[..., Any]]: Activities for:
                - Getting query batches
                - Fetching queries
                - Preflight check
        """
        
    @workflow.run
    async def run(self, workflow_config: Dict[str, Any]):
        """Run the workflow.
        
        Args:
            workflow_config: Includes workflow_id and other parameters
            
        Note:
            - Processes queries in batches
            - Handles parallel execution
            - Manages workflow state
        """
```

## Common Features and Best Practices

### Workflow Execution
1. Configuration Management
   - State store integration
   - Workflow ID handling
   - Run ID tracking

2. Activity Management
   - Retry policies
   - Timeout handling
   - Heartbeat monitoring

3. Error Handling
   - Exception logging
   - Error recovery
   - State preservation

### Performance Optimization
1. Batch Processing
   - Configurable batch sizes
   - Parallel execution
   - Resource management

2. State Management
   - Efficient state updates
   - Memory optimization
   - State persistence

3. Resource Usage
   - Timeout configuration
   - Heartbeat intervals
   - Activity limits

### Best Practices
1. Code Quality
   - Type hints
   - Comprehensive documentation
   - Clear error messages
   - Consistent naming

2. Error Handling
   - Graceful degradation
   - Proper logging
   - Recovery mechanisms
   - State preservation

3. Performance
   - Efficient batching
   - Parallel processing
   - Resource optimization
   - Memory management

4. Maintainability
   - Modular design
   - Clear interfaces
   - Reusable components
   - Testable workflows 