# Application SDK Application Documentation

This document provides comprehensive documentation for the Application SDK's application module, which implements the core application interface and FastAPI-based web application.

## Table of Contents
1. [Base Application Interface](#base-application-interface)
2. [FastAPI Application](#fastapi-application)
3. [FastAPI Agent Application](#fastapi-agent-application)
4. [Models](#models)
5. [Workflow Triggers](#workflow-triggers)
6. [API Endpoints](#api-endpoints)
7. [Server Router](#server-router)
8. [Middleware](#middleware)

## Base Application Interface

### AtlanApplicationInterface
Abstract base class for Atlan applications.

**Attributes:**
- `handler` (Optional[HandlerInterface]): Handler instance for processing application-specific operations

**Methods:**
- `__init__(handler: Optional[HandlerInterface] = None)`: Initialize with optional handler
- `start() -> None`: Abstract method for application startup

## FastAPI Application

### FastAPIApplication
FastAPI-based web application implementation of the Atlan Application Interface.

**Attributes:**
- `app` (FastAPI): Main FastAPI application instance
- `temporal_client` (Optional[TemporalClient]): Client for Temporal workflow operations
- `workflow_router` (APIRouter): Router for workflow endpoints
- `pubsub_router` (APIRouter): Router for pub/sub operations
- `events_router` (APIRouter): Router for event handling
- `docs_directory_path` (str): Path to documentation source (default: "docs")
- `docs_export_path` (str): Path for exported documentation (default: "dist")
- `workflows` (List[WorkflowInterface]): Registered workflows
- `event_triggers` (List[EventWorkflowTrigger]): Event-based workflow triggers

**Methods:**
- `__init__(lifespan=None, handler=None, temporal_client=None)`: Initialize application
- `setup_atlan_docs()`: Set up and serve Atlan documentation
- `register_routers()`: Register all application routers
- `register_workflow(workflow_class, triggers)`: Register workflow with triggers
- `register_routes()`: Register application routes
- `get_dapr_subscriptions() -> List[dict]`: Get Dapr subscriptions
- `on_event(event: dict)`: Handle incoming events
- `test_auth(body: TestAuthRequest) -> TestAuthResponse`: Test authentication
- `fetch_metadata(body: FetchMetadataRequest) -> FetchMetadataResponse`: Fetch metadata
- `preflight_check(body: PreflightCheckRequest) -> PreflightCheckResponse`: Perform preflight check
- `get_workflow_config(config_id: str) -> WorkflowConfigResponse`: Get workflow configuration
- `get_workflow_run_status(workflow_id: str, run_id: str) -> JSONResponse`: Get workflow status
- `update_workflow_config(config_id: str, body: WorkflowConfigRequest) -> WorkflowConfigResponse`: Update workflow config
- `stop_workflow(workflow_id: str, run_id: str) -> JSONResponse`: Stop workflow
- `start(host: str = "0.0.0.0", port: int = 8000)`: Start the application server

## FastAPI Agent Application

### FastAPIAgentApplication
FastAPI application with agent capabilities.

**Attributes:**
- `agent_router` (APIRouter): Router for agent endpoints
- `temporal_client` (Optional[TemporalClient]): Temporal workflow client
- `worker` (Optional[Worker]): Worker instance
- `workflow_handles` (Dict[str, Any]): Workflow handles
- `graph_builder_name` (str): Name of the graph builder

**Methods:**
- `__init__(*args, **kwargs)`: Initialize agent application
- `register_routers()`: Register application routers
- `register_routes()`: Register application routes
- `process_query(request: AgentRequest) -> Dict[str, Any]`: Process agent query
- `get_workflow_result(workflow_id: str) -> Dict[str, Any]`: Get workflow result
- `setup_worker(temporal_client: TemporalClient) -> Worker`: Set up worker
- `register_graph(state_graph_builder, graph_builder_name="workflow")`: Register graph builder

## Models

### Request/Response Models
- `TestAuthRequest`: Authentication test request
- `TestAuthResponse`: Authentication test response
- `FetchMetadataRequest`: Metadata fetch request
- `FetchMetadataResponse`: Metadata fetch response
- `PreflightCheckRequest`: Preflight check request
- `PreflightCheckResponse`: Preflight check response
- `WorkflowRequest`: Workflow execution request
- `WorkflowData`: Workflow data model
- `WorkflowResponse`: Workflow execution response
- `WorkflowConfigRequest`: Workflow configuration request
- `WorkflowConfigResponse`: Workflow configuration response

### Enums
- `MetadataType`: Types of metadata (DATABASE, SCHEMA, ALL)

## Workflow Triggers

### WorkflowTrigger
Base class for workflow triggers.

**Attributes:**
- `workflow_class` (Optional[Type[WorkflowInterface]]): Associated workflow class

### HttpWorkflowTrigger
HTTP-based workflow trigger.

**Attributes:**
- `endpoint` (str): HTTP endpoint
- `methods` (List[str]): HTTP methods

### EventWorkflowTrigger
Event-based workflow trigger.

**Attributes:**
- `should_trigger_workflow` (Callable[[Any], bool]): Trigger condition function

## API Endpoints

### Workflow Endpoints
- `POST /workflows/v1/auth`: Test authentication
- `POST /workflows/v1/metadata`: Fetch metadata
- `POST /workflows/v1/check`: Perform preflight check
- `GET /workflows/v1/config/{config_id}`: Get workflow configuration
- `POST /workflows/v1/config/{config_id}`: Update workflow configuration
- `GET /workflows/v1/status/{workflow_id}/{run_id}`: Get workflow status
- `POST /workflows/v1/stop/{workflow_id}/{run_id}`: Stop workflow

### Agent Endpoints
- `POST /agent/query`: Process agent query
- `GET /agent/result/{workflow_id}`: Get workflow result

### Documentation
- `/atlandocs`: Served documentation

## Usage Examples

### Basic Application
```python
app = FastAPIApplication(
    handler=MyHandler(),
    temporal_client=TemporalClient()
)
await app.start()
```

### Agent Application
```python
app = FastAPIAgentApplication(
    handler=MyHandler(),
    temporal_client=TemporalClient()
)

def my_graph_builder():
    return StateGraph()

app.register_graph(my_graph_builder)
await app.start()
```

### Registering Workflows
```python
app.register_workflow(
    MyWorkflow,
    triggers=[
        HttpWorkflowTrigger(
            endpoint="/my-workflow",
            methods=["POST"]
        )
    ]
)
```

## Error Handling

The application includes comprehensive error handling:
- HTTP 500 error handler
- Workflow execution error handling
- Authentication validation
- Preflight checks
- Resource cleanup

## Best Practices

1. Always implement proper error handling
2. Use appropriate request/response models
3. Register workflows with appropriate triggers
4. Implement proper authentication
5. Follow FastAPI best practices for route definitions
6. Use proper type hints and documentation
7. Implement proper resource cleanup

## Server Router

### Server Router Endpoints
The server router provides system-level endpoints for health checks, readiness probes, and graceful shutdown.

**Endpoints:**
- `GET /server/health`: Check system health
  - Returns system information including:
    - Platform details (system, release, version)
    - Architecture
    - Hostname
    - IP address
    - MAC address
    - Processor information
    - RAM usage
- `GET /server/ready`: Check system readiness
  - Returns `{"status": "ok"}` if system is ready
- `POST /server/shutdown`: Gracefully stop the application
  - Optional `force` parameter to force immediate shutdown
  - Cancels pending tasks and terminates the process

**Helper Functions:**
- `get_ip_address()`: Get system IP address with fallback options
- `terminate_process()`: Terminate the parent process
- `get_server_router()`: Get the server router instance

## Middleware

### LogMiddleware
Middleware for request logging and tracking.

**Features:**
- Request ID generation and tracking
- Request timing and duration measurement
- Detailed request logging including:
  - HTTP method
  - URL path
  - Status code
  - Duration
  - Client host
  - Request ID
- Error logging with full stack traces
- Context management for request tracking

**Implementation Details:**
- Inherits from `BaseHTTPMiddleware`
- Uses `request_context` for request ID tracking
- Handles request lifecycle:
  - Request start logging
  - Response completion logging
  - Error logging
  - Context cleanup

**Example Log Output:**
```json
{
  "method": "GET",
  "path": "/api/endpoint",
  "request_id": "uuid",
  "url": "http://example.com/api/endpoint",
  "client_host": "127.0.0.1",
  "status_code": 200,
  "duration_ms": 123.45
}
``` 