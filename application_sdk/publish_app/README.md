# Atlas Publish Application

A robust workflow for publishing metadata to Atlas using a plan-execute pattern.

## Overview

The Atlas Publish Application is designed to handle large-scale metadata publishing to Atlas with:

- A two-phase approach (plan then execute)
- Robust error handling and retry logic
- Support for high-density asset types
- Special handling for self-referential types
- State tracking for each operation
- Concurrency control

## Architecture

The application follows a plan-execute pattern:

1. **Plan Phase**: Analyzes input data and creates an execution plan
   - Discovers data directories and files
   - Builds dependency graph between asset types
   - Creates ordered layers for execution
   - Identifies self-referential types
   - Assigns processing strategies

2. **Execute Phase**: Carries out the plan with no further decision-making
   - Processes asset types in the specified order
   - Executes create/update operations before deletes
   - Uses different processors based on asset type density
   - Tracks operation state
   - Handles errors according to configuration

## Components

### Workflow

- `AtlasPublishAtlanWorkflow`: Main workflow class orchestrating the plan and execute activities

### Activities

- `plan`: Analyzes input data and creates execution plan
- `publish`: Executes the plan, handling create/update and delete operations

### Models

- `PublishConfig`: Configuration for the publish workflow
- `PublishPlan`: Plan generated by the planner phase
- `AssetTypeAssignment`: Assignment for a specific asset type
- `FileAssignment`: Assignment for a specific file (for high-density types)

### Processors

- `BaseProcessor`: Base class with common processing functionality
- `TypeLevelProcessor`: Processor for standard asset types
- `FileLevelProcessor`: Processor for high-density asset types with file-level parallelism
- `SelfRefProcessor`: Processor for self-referential types using a two-pass approach

### Client

- `AtlasClient`: Robust client for Atlas API with authentication, retry and error handling

### Utils

- `OutputAdapter`: Converts processed records to the required output format

## Usage

```python
from application_sdk.publish_app.workflows.atlas import AtlasPublishAtlanWorkflow
from application_sdk.publish_app.models.plan import PublishConfig

# Create configuration
config = PublishConfig(
    concurrency_activities=5,
    max_activity_concurrency=10,
    username="your_atlas_username",
    high_density_asset_types=["Column"],
    publish_chunk_count=50,
    continue_on_error=False
)

# Set up workflow arguments
workflow_args = {
    "input_data_path": "/path/to/diff",
    "config": config,
    "state_store": state_store_client
}

# Run workflow
result = await handle.execute_workflow(
    AtlasPublishAtlanWorkflow.run,
    workflow_args,
    id="atlas-publish-workflow-1",
    task_queue="atlas-publish-queue"
)
```

## Configuration Options

| Option | Description | Default |
|--------|-------------|---------|
| `concurrency_activities` | Number of concurrent activities | 5 |
| `max_activity_concurrency` | Maximum concurrency per worker | 10 |
| `high_density_asset_types` | Types processed with file-level parallelism | ["Column"] |
| `publish_chunk_count` | Records per API call | 50 |
| `retry_config.max_retries` | Maximum retry attempts | 3 |
| `retry_config.backoff_factor` | Exponential backoff factor | 2 |
| `continue_on_error` | Continue on error flag | false |
| `atlas_timeout` | Timeout for Atlas API calls (seconds) | 60 |

## Output Format

The application processes input records and produces output with additional status fields:

```
{
    // Original fields
    "qualified_name": "default/postgres/1688410509/dynamic_dealer_pricing",
    "record": "...",
    "type_name": "Database",
    "attributes_hash": "93d25ee18b2f22b44d3ca2193a51902c",
    "diff_status": "DELETE",

    // Added status fields
    "status": "SUCCESS", // or "FAILED"
    "error_code": null,
    "atlas_error_code": null,
    "error_description": null,
    "request_config": {
        "api_endpoint": "/api/atlas/v2/entity/guid/12345-abcd-67890",
        "method": "DELETE",
        "retry_count": 3
    },
    "runbook_link": null
}
```

## Error Handling

The application provides comprehensive error handling:

- Configurable retry behavior with exponential backoff
- Option to continue on error or fail fast
- Detailed error tracking for each record
- State persistence for auditing and recovery