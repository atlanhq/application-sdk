# Brief of New Architecture

Instead of running the diff + publish steps at the end of every workflow run, we want to decouple it and make it a long running workflow that runs all the time.

This publish app will keep running and pick S3 prefixes that have the transformed data and then process them.

## Separation of Responsibility

- The whole reason we are doing this architecture change is the separation of responsibility.
- Apps (workflows) if they only contain the Extract + Transform steps, we can always point those workflow failures to the customer and get them all the help they need to debug and fix source nuances.
- And because the diff + publish is central, we always monitor the publish queue, build the standard observability and reporting primitives on it and do not bother the customers for failures we can fix easily.

## Sample Payload

The following are the sample payloads we work with.

```json
{"typeName":"View","attributes":{"qualifiedName":"default\/postgres\/1688410509\/dynamic_dealer_pricing\/public\/pg_stat_statements","name":"pg_stat_statements","tenantId":"default","connectorName":"postgres","connectionName":"postgres","connectionQualifiedName":"default\/postgres\/1688410509","lastSyncWorkflowName":"atlan-postgres-1688410509-cron-1743358860","lastSyncRunAt":1743359105357,"lastSyncRun":"c45e31b6-444b-4ffa-ba83-e233fb5bf614","databaseName":"dynamic_dealer_pricing","databaseQualifiedName":"default\/postgres\/1688410509\/dynamic_dealer_pricing","schemaName":"public","schemaQualifiedName":"default\/postgres\/1688410509\/dynamic_dealer_pricing\/public","columnCount":23,"rowCount":0,"sizeBytes":0,"definition":"CREATE OR REPLACE VIEW pg_stat_statements AS  SELECT pg_stat_statements.userid,\n    pg_stat_statements.dbid,\n    pg_stat_statements.queryid,\n    pg_stat_statements.query,\n    pg_stat_statements.calls,\n    pg_stat_statements.total_time,\n    pg_stat_statements.min_time,\n    pg_stat_statements.max_time,\n    pg_stat_statements.mean_time,\n    pg_stat_statements.stddev_time,\n    pg_stat_statements.rows,\n    pg_stat_statements.shared_blks_hit,\n    pg_stat_statements.shared_blks_read,\n    pg_stat_statements.shared_blks_dirtied,\n    pg_stat_statements.shared_blks_written,\n    pg_stat_statements.local_blks_hit,\n    pg_stat_statements.local_blks_read,\n    pg_stat_statements.local_blks_dirtied,\n    pg_stat_statements.local_blks_written,\n    pg_stat_statements.temp_blks_read,\n    pg_stat_statements.temp_blks_written,\n    pg_stat_statements.blk_read_time,\n    pg_stat_statements.blk_write_time\n   FROM pg_stat_statements(true) pg_stat_statements(userid, dbid, queryid, query, calls, total_time, min_time, max_time, mean_time, stddev_time, rows, shared_blks_hit, shared_blks_read, shared_blks_dirtied, shared_blks_written, local_blks_hit, local_blks_read, local_blks_dirtied, local_blks_written, temp_blks_read, temp_blks_written, blk_read_time, blk_write_time);","atlanSchema":{"typeName":"Schema","attributes":{},"uniqueAttributes":{"qualifiedName":"default\/postgres\/1688410509\/dynamic_dealer_pricing\/public"}}},"status":"ACTIVE","customAttributes":{"table_type":"VIEW","is_insertable_into":"NO","number_columns_in_part_key":null,"columns_participating_in_part_key":null,"is_typed":"NO","engine":null,"self_referencing_col_name":"","ref_generation":""}}

{"typeName":"Table","attributes":{"qualifiedName":"default\/postgres\/1688410509\/dynamic_dealer_pricing\/public\/dynamic_dealer_pricing_records","name":"dynamic_dealer_pricing_records","description":"Table containing dynamic dealer pricing related data.","tenantId":"default","connectorName":"postgres","connectionName":"postgres","connectionQualifiedName":"default\/postgres\/1688410509","lastSyncWorkflowName":"atlan-postgres-1688410509-cron-1743358860","lastSyncRunAt":1743359105357,"lastSyncRun":"c45e31b6-444b-4ffa-ba83-e233fb5bf614","databaseName":"dynamic_dealer_pricing","databaseQualifiedName":"default\/postgres\/1688410509\/dynamic_dealer_pricing","schemaName":"public","schemaQualifiedName":"default\/postgres\/1688410509\/dynamic_dealer_pricing\/public","columnCount":13,"rowCount":844,"sizeBytes":0,"externalLocation":"","externalLocationRegion":"","externalLocationFormat":"","isPartitioned":false,"atlanSchema":{"typeName":"Schema","attributes":{},"uniqueAttributes":{"qualifiedName":"default\/postgres\/1688410509\/dynamic_dealer_pricing\/public"}}},"status":"ACTIVE","customAttributes":{"table_type":"TABLE","is_insertable_into":null,"number_columns_in_part_key":null,"columns_participating_in_part_key":null,"is_typed":null,"engine":null,"self_referencing_col_name":"","ref_generation":""}}

{"typeName":"Database","attributes":{"qualifiedName":"default\/postgres\/1688410509\/dynamic_dealer_pricing","name":"dynamic_dealer_pricing","tenantId":"default","connectorName":"postgres","connectionName":"postgres","connectionQualifiedName":"default\/postgres\/1688410509","lastSyncWorkflowName":"atlan-postgres-1688410509-cron-1743358860","lastSyncRunAt":1743359105558,"lastSyncRun":"c45e31b6-444b-4ffa-ba83-e233fb5bf614","schemaCount":0},"status":"ACTIVE","customAttributes":{}}

{"typeName":"Column","attributes":{"qualifiedName":"default\/postgres\/1688410509\/dynamic_dealer_pricing\/public\/dealer_fee\/row_id","name":"row_id","description":"auto-increments - primary key column.","tenantId":"default","connectorName":"postgres","connectionName":"postgres","connectionQualifiedName":"default\/postgres\/1688410509","lastSyncWorkflowName":"atlan-postgres-1688410509-cron-1743358860","lastSyncRunAt":1743359105795,"lastSyncRun":"c45e31b6-444b-4ffa-ba83-e233fb5bf614","databaseName":"dynamic_dealer_pricing","databaseQualifiedName":"default\/postgres\/1688410509\/dynamic_dealer_pricing","schemaName":"public","schemaQualifiedName":"default\/postgres\/1688410509\/dynamic_dealer_pricing\/public","tableName":"dealer_fee","tableQualifiedName":"default\/postgres\/1688410509\/dynamic_dealer_pricing\/public\/dealer_fee","dataType":"int4","order":1,"isPartition":false,"isPrimary":true,"isForeign":false,"precision":32,"isNullable":false,"numericScale":0.0,"maxLength":0,"table":{"typeName":"Table","attributes":{},"uniqueAttributes":{"qualifiedName":"default\/postgres\/1688410509\/dynamic_dealer_pricing\/public\/dealer_fee"}}},"status":"ACTIVE","customAttributes":{"ordinal_position":1,"is_self_referencing":"NO","type_name":"int4","is_auto_increment":"YES","is_generated":"NO","column_size":"integer","is_identity":"NO","identity_cycle":null}}

{"typeName":"Procedure","attributes":{"qualifiedName":"default\/postgres\/1688410509\/dynamic_dealer_pricing\/public\/_procedures_\/pg_stat_statements","name":"pg_stat_statements","tenantId":"default","connectorName":"postgres","connectionName":"postgres","connectionQualifiedName":"default\/postgres\/1688410509","subType":"-1","sourceCreatedBy":"rdsadmin","lastSyncWorkflowName":"atlan-postgres-1688410509-cron-1743358860","lastSyncRunAt":1743359105477,"lastSyncRun":"c45e31b6-444b-4ffa-ba83-e233fb5bf614","databaseName":"dynamic_dealer_pricing","databaseQualifiedName":"default\/postgres\/1688410509\/dynamic_dealer_pricing","schemaName":"public","schemaQualifiedName":"default\/postgres\/1688410509\/dynamic_dealer_pricing\/public","definition":"pg_stat_statements_1_3","atlanSchema":{"typeName":"Schema","attributes":{},"uniqueAttributes":{"qualifiedName":"default\/postgres\/1688410509\/dynamic_dealer_pricing\/public"}}},"status":"ACTIVE","customAttributes":{}}

{"typeName":"Schema","attributes":{"qualifiedName":"default\/postgres\/1688410509\/dynamic_dealer_pricing\/public","name":"public","tenantId":"default","connectorName":"postgres","connectionName":"postgres","connectionQualifiedName":"default\/postgres\/1688410509","lastSyncWorkflowName":"atlan-postgres-1688410509-cron-1743358860","lastSyncRunAt":1743359105845,"lastSyncRun":"c45e31b6-444b-4ffa-ba83-e233fb5bf614","databaseName":"dynamic_dealer_pricing","databaseQualifiedName":"default\/postgres\/1688410509\/dynamic_dealer_pricing","tableCount":4,"viewsCount":1,"database":{"typeName":"Database","attributes":{},"uniqueAttributes":{"qualifiedName":"default\/postgres\/1688410509\/dynamic_dealer_pricing"}}},"status":"ACTIVE","customAttributes":{}}
```
